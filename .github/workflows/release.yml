name: Release
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  GO_VERSION: '1.21'

jobs:
  release:
    runs-on: ubuntu-latest
    name: Create Release
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run tests
        run: go test -v ./...

      - name: Create release directories
        run: |
          mkdir -p release/windows
          mkdir -p release/linux
          mkdir -p release/macos

      - name: Build for multiple platforms
        run: |
          # Windows AMD64
          GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o release/windows/tg-down.exe cmd/main.go
          
          # Linux AMD64
          GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o release/linux/tg-down cmd/main.go
          
          # Linux ARM64
          GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o tg-down-linux-arm64 cmd/main.go
          
          # macOS AMD64
          GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o release/macos/tg-down cmd/main.go
          
          # macOS ARM64 (Apple Silicon)
          GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o tg-down-darwin-arm64 cmd/main.go

      - name: Create Windows package
        run: |
          # å¤åˆ¶å¿…è¦æ–‡ä»¶åˆ° Windows åŒ…
          cp config.yaml.example release/windows/config.yaml
          cp .env.example release/windows/.env.example
          cp LICENSE release/windows/
          
          # åˆ›å»º Windows å¯åŠ¨è„šæœ¬
          cat > release/windows/start.bat << 'EOF'
          @echo off
          chcp 65001 > nul
          title Telegramåª’ä½“ä¸‹è½½å™¨
          
          echo ========================================
          echo    Telegramç¾¤èŠåª’ä½“ä¸‹è½½å™¨ v${GITHUB_REF#refs/tags/}
          echo ========================================
          echo.
          
          REM æ£€æŸ¥é…ç½®æ–‡ä»¶
          if not exist "config.yaml" (
              echo é¦–æ¬¡è¿è¡Œï¼Œæ­£åœ¨åˆ›å»ºé…ç½®æ–‡ä»¶...
              echo è¯·ç¼–è¾‘ config.yaml æ–‡ä»¶ï¼Œå¡«å…¥æ‚¨çš„ Telegram API ä¿¡æ¯
              echo.
              echo é…ç½®å®Œæˆåï¼Œå†æ¬¡è¿è¡Œæ­¤è„šæœ¬å³å¯å¼€å§‹ä½¿ç”¨
              echo.
              pause
              exit /b 1
          )
          
          REM åˆ›å»ºå¿…è¦ç›®å½•
          if not exist "downloads" mkdir downloads
          if not exist "sessions" mkdir sessions
          
          echo æ­£åœ¨å¯åŠ¨ç¨‹åº...
          echo.
          tg-down.exe
          
          if errorlevel 1 (
              echo.
              echo ç¨‹åºè¿è¡Œå‡ºé”™ï¼Œè¯·æ£€æŸ¥é…ç½®æ–‡ä»¶
              pause
          )
          EOF
          
          # åˆ›å»ºé…ç½®è¯´æ˜æ–‡ä»¶
          cat > release/windows/é…ç½®è¯´æ˜.txt << 'EOF'
          Telegramåª’ä½“ä¸‹è½½å™¨ - é…ç½®è¯´æ˜
          ================================
          
          1. é¦–æ¬¡ä½¿ç”¨å‰ï¼Œè¯·ç¼–è¾‘ config.yaml æ–‡ä»¶ï¼š
             - api.id: æ‚¨çš„ Telegram API ID
             - api.hash: æ‚¨çš„ Telegram API Hash
             - api.phone: æ‚¨çš„æ‰‹æœºå·ï¼ˆåŒ…å«å›½å®¶ä»£ç ï¼Œå¦‚ +86ï¼‰
             - chat.target_id: è¦ä¸‹è½½çš„ç¾¤ç»„IDï¼ˆå¯é€‰ï¼‰
          
          2. è·å– API ä¿¡æ¯ï¼š
             - è®¿é—® https://my.telegram.org/apps
             - ç™»å½•æ‚¨çš„ Telegram è´¦å·
             - åˆ›å»ºæ–°åº”ç”¨è·å– API ID å’Œ Hash
          
          3. ä½¿ç”¨æ–¹æ³•ï¼š
             - åŒå‡» start.bat å¯åŠ¨ç¨‹åº
             - é¦–æ¬¡è¿è¡Œä¼šè¦æ±‚è¾“å…¥éªŒè¯ç 
             - ç¨‹åºä¼šè‡ªåŠ¨ä¸‹è½½æŒ‡å®šç¾¤ç»„çš„åª’ä½“æ–‡ä»¶
          
          4. ä¸‹è½½çš„æ–‡ä»¶ä¿å­˜åœ¨ downloads ç›®å½•ä¸­
          
          5. å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹é¡¹ç›®ä¸»é¡µï¼š
             https://github.com/Heartcoolman/Tg-Down
          EOF

      - name: Create Linux package
        run: |
          # å¤åˆ¶å¿…è¦æ–‡ä»¶åˆ° Linux åŒ…
          cp config.yaml.example release/linux/config.yaml
          cp .env.example release/linux/.env.example
          cp LICENSE release/linux/
          
          # åˆ›å»º Linux å¯åŠ¨è„šæœ¬
          cat > release/linux/start.sh << 'EOF'
          #!/bin/bash
          
          echo "========================================"
          echo "   Telegramç¾¤èŠåª’ä½“ä¸‹è½½å™¨ v${GITHUB_REF#refs/tags/}"
          echo "========================================"
          echo
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ ! -f "config.yaml" ]; then
              echo "é¦–æ¬¡è¿è¡Œï¼Œè¯·å…ˆé…ç½® config.yaml æ–‡ä»¶"
              echo "è¯·ç¼–è¾‘ config.yaml æ–‡ä»¶ï¼Œå¡«å…¥æ‚¨çš„ Telegram API ä¿¡æ¯"
              echo
              echo "é…ç½®å®Œæˆåï¼Œå†æ¬¡è¿è¡Œæ­¤è„šæœ¬å³å¯å¼€å§‹ä½¿ç”¨"
              echo
              exit 1
          fi
          
          # åˆ›å»ºå¿…è¦ç›®å½•
          mkdir -p downloads
          mkdir -p sessions
          
          # è®¾ç½®å¯æ‰§è¡Œæƒé™
          chmod +x tg-down
          
          echo "æ­£åœ¨å¯åŠ¨ç¨‹åº..."
          echo
          ./tg-down
          EOF
          
          chmod +x release/linux/start.sh
          chmod +x release/linux/tg-down
          
          # åˆ›å»ºé…ç½®è¯´æ˜æ–‡ä»¶
          cat > release/linux/README.txt << 'EOF'
          Telegramåª’ä½“ä¸‹è½½å™¨ - Linuxç‰ˆæœ¬
          =============================
          
          1. é¦–æ¬¡ä½¿ç”¨å‰ï¼Œè¯·ç¼–è¾‘ config.yaml æ–‡ä»¶ï¼š
             - api.id: æ‚¨çš„ Telegram API ID
             - api.hash: æ‚¨çš„ Telegram API Hash
             - api.phone: æ‚¨çš„æ‰‹æœºå·ï¼ˆåŒ…å«å›½å®¶ä»£ç ï¼Œå¦‚ +86ï¼‰
             - chat.target_id: è¦ä¸‹è½½çš„ç¾¤ç»„IDï¼ˆå¯é€‰ï¼‰
          
          2. è·å– API ä¿¡æ¯ï¼š
             - è®¿é—® https://my.telegram.org/apps
             - ç™»å½•æ‚¨çš„ Telegram è´¦å·
             - åˆ›å»ºæ–°åº”ç”¨è·å– API ID å’Œ Hash
          
          3. ä½¿ç”¨æ–¹æ³•ï¼š
             - è¿è¡Œ: ./start.sh
             - æˆ–ç›´æ¥è¿è¡Œ: ./tg-down
          
          4. ä¸‹è½½çš„æ–‡ä»¶ä¿å­˜åœ¨ downloads ç›®å½•ä¸­
          
          5. å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹é¡¹ç›®ä¸»é¡µï¼š
             https://github.com/Heartcoolman/Tg-Down
          EOF

      - name: Create macOS package
        run: |
          # å¤åˆ¶å¿…è¦æ–‡ä»¶åˆ° macOS åŒ…
          cp config.yaml.example release/macos/config.yaml
          cp .env.example release/macos/.env.example
          cp LICENSE release/macos/
          
          # åˆ›å»º macOS å¯åŠ¨è„šæœ¬
          cat > release/macos/start.sh << 'EOF'
          #!/bin/bash
          
          echo "========================================"
          echo "   Telegramç¾¤èŠåª’ä½“ä¸‹è½½å™¨ v${GITHUB_REF#refs/tags/}"
          echo "========================================"
          echo
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ ! -f "config.yaml" ]; then
              echo "é¦–æ¬¡è¿è¡Œï¼Œè¯·å…ˆé…ç½® config.yaml æ–‡ä»¶"
              echo "è¯·ç¼–è¾‘ config.yaml æ–‡ä»¶ï¼Œå¡«å…¥æ‚¨çš„ Telegram API ä¿¡æ¯"
              echo
              echo "é…ç½®å®Œæˆåï¼Œå†æ¬¡è¿è¡Œæ­¤è„šæœ¬å³å¯å¼€å§‹ä½¿ç”¨"
              echo
              exit 1
          fi
          
          # åˆ›å»ºå¿…è¦ç›®å½•
          mkdir -p downloads
          mkdir -p sessions
          
          # è®¾ç½®å¯æ‰§è¡Œæƒé™
          chmod +x tg-down
          
          echo "æ­£åœ¨å¯åŠ¨ç¨‹åº..."
          echo
          ./tg-down
          EOF
          
          chmod +x release/macos/start.sh
          chmod +x release/macos/tg-down
          
          # åˆ›å»ºé…ç½®è¯´æ˜æ–‡ä»¶
          cat > release/macos/README.txt << 'EOF'
          Telegramåª’ä½“ä¸‹è½½å™¨ - macOSç‰ˆæœ¬
          =============================
          
          1. é¦–æ¬¡ä½¿ç”¨å‰ï¼Œè¯·ç¼–è¾‘ config.yaml æ–‡ä»¶ï¼š
             - api.id: æ‚¨çš„ Telegram API ID
             - api.hash: æ‚¨çš„ Telegram API Hash
             - api.phone: æ‚¨çš„æ‰‹æœºå·ï¼ˆåŒ…å«å›½å®¶ä»£ç ï¼Œå¦‚ +86ï¼‰
             - chat.target_id: è¦ä¸‹è½½çš„ç¾¤ç»„IDï¼ˆå¯é€‰ï¼‰
          
          2. è·å– API ä¿¡æ¯ï¼š
             - è®¿é—® https://my.telegram.org/apps
             - ç™»å½•æ‚¨çš„ Telegram è´¦å·
             - åˆ›å»ºæ–°åº”ç”¨è·å– API ID å’Œ Hash
          
          3. ä½¿ç”¨æ–¹æ³•ï¼š
             - è¿è¡Œ: ./start.sh
             - æˆ–ç›´æ¥è¿è¡Œ: ./tg-down
          
          4. ä¸‹è½½çš„æ–‡ä»¶ä¿å­˜åœ¨ downloads ç›®å½•ä¸­
          
          5. æ³¨æ„ï¼šé¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸è¿è¡Œ
          
          6. å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹é¡¹ç›®ä¸»é¡µï¼š
             https://github.com/Heartcoolman/Tg-Down
          EOF

      - name: Create release packages
        run: |
          # åˆ›å»ºå‹ç¼©åŒ…
          cd release
          
          # Windows åŒ…
          zip -r ../tg-down-windows-amd64.zip windows/
          
          # Linux åŒ…
          tar -czf ../tg-down-linux-amd64.tar.gz linux/
          
          # macOS åŒ…
          tar -czf ../tg-down-macos-amd64.tar.gz macos/
          
          cd ..

      - name: Create checksums
        run: |
          sha256sum tg-down-*.zip tg-down-*.tar.gz tg-down-*-arm64 > checksums.txt
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            tg-down-windows-amd64.zip
            tg-down-linux-amd64.tar.gz
            tg-down-macos-amd64.tar.gz
            tg-down-linux-arm64
            tg-down-darwin-arm64
            checksums.txt
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## ğŸ“¦ å®Œæ•´æ‰“åŒ…ç‰ˆæœ¬ - å¼€ç®±å³ç”¨
            
            æœ¬ç‰ˆæœ¬æä¾›å®Œæ•´çš„æ‰“åŒ…æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦çš„é…ç½®æ–‡ä»¶å’Œå¯åŠ¨è„šæœ¬ï¼Œä¸‹è½½åå³å¯ä½¿ç”¨ï¼
            
            ### ğŸš€ å¿«é€Ÿå¼€å§‹
            
            1. **ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…**
            2. **è§£å‹åˆ°ä»»æ„ç›®å½•**
            3. **ç¼–è¾‘ config.yaml æ–‡ä»¶ï¼Œå¡«å…¥æ‚¨çš„ Telegram API ä¿¡æ¯**
            4. **åŒå‡»å¯åŠ¨è„šæœ¬å³å¯è¿è¡Œ**
            
            ### ğŸ“‹ æ–‡ä»¶è¯´æ˜
            
            - **Windows**: `tg-down-windows-amd64.zip`
              - åŒ…å«: `tg-down.exe`, `start.bat`, `config.yaml`, `é…ç½®è¯´æ˜.txt`
              - ä½¿ç”¨: åŒå‡» `start.bat` å¯åŠ¨
            
            - **Linux**: `tg-down-linux-amd64.tar.gz`
              - åŒ…å«: `tg-down`, `start.sh`, `config.yaml`, `README.txt`
              - ä½¿ç”¨: è¿è¡Œ `./start.sh` å¯åŠ¨
            
            - **macOS**: `tg-down-macos-amd64.tar.gz`
              - åŒ…å«: `tg-down`, `start.sh`, `config.yaml`, `README.txt`
              - ä½¿ç”¨: è¿è¡Œ `./start.sh` å¯åŠ¨
            
            ### ğŸ”§ é…ç½®è¯´æ˜
            
            é¦–æ¬¡ä½¿ç”¨å‰ï¼Œè¯·ç¼–è¾‘ `config.yaml` æ–‡ä»¶ï¼š
            1. è®¿é—® https://my.telegram.org/apps è·å– API ä¿¡æ¯
            2. å¡«å…¥ API IDã€API Hash å’Œæ‰‹æœºå·
            3. å¯é€‰ï¼šè®¾ç½®è¦ä¸‹è½½çš„ç¾¤ç»„ID
            
            ### ğŸ’¡ ç‰¹æ€§
            
            - âœ… å¼€ç®±å³ç”¨ï¼Œæ— éœ€é¢å¤–é…ç½®
            - âœ… è‡ªåŠ¨åˆ›å»ºå¿…è¦ç›®å½•
            - âœ… åŒ…å«è¯¦ç»†çš„ä½¿ç”¨è¯´æ˜
            - âœ… æ”¯æŒå¤šå¹³å°ï¼ˆWindows/Linux/macOSï¼‰
            - âœ… ä¸€é”®å¯åŠ¨è„šæœ¬

  dependency-submission:
    runs-on: ubuntu-latest
    name: Submit Dependencies for Release
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run Go Dependency Submission
        uses: actions/go-dependency-submission@v2
        with:
          go-mod-path: go.mod
          go-build-target: cmd/main.go